<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Thông tin cá nhân</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
          integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
          integrity="sha512-vKMx8UnXk60zUwyUnUPM3HbQo8QfmNx7+ltw8Pm5zLusl1XIfwcxo8DbWCqMGKaWeNxWA8yrx5v3SaVpMvR3CA=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <link rel="stylesheet" th:href="@{/web-assets/css/style.css}">
</head>
<body>
<header class="bg-dark">
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="https://motchilltv.io/logo_motchill.png" alt="" class="logo">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
                    aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-between" id="navbarNavAltMarkup">
                <div class="navbar-nav">
                    <a class="nav-link text-white" href="/">Trang chủ</a>
                    <a class="nav-link text-white" href="/phim-bo">Phim bộ</a>
                    <a class="nav-link text-white" href="/phim-le">Phim lẻ</a>
                    <a class="nav-link text-white" href="/phim-chieu-rap">Phim chiếu rạp</a>
                    <a class="nav-link text-white" href="#">Quốc gia</a>
                    <a class="nav-link text-white" href="#">Thể loại</a>
                </div>

                <div>
                    <a th:if="${session.currentUser == null}" class="text-white" href="/dang-nhap">Đăng nhập</a>

                    <div class="dropdown" th:if="${session.currentUser != null}">
                        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                                aria-expanded="false" th:text="${session.currentUser.name}">
                            Bui Hien
                        </button>
                        <ul class="dropdown-menu">
                            <li th:if="${session.currentUser.role.toString() == 'ADMIN'}">
                                <a class="dropdown-item" href="/admin">Trang quản trị</a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="/thong-tin-ca-nhan">Thông tin cá nhân</a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="/phim-yeu-thich">Phim yêu thích</a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="/lich-su-xem-phim">Lịch sử xem phim</a>
                            </li>
                            <li>
                                <span class="dropdown-item" style="cursor: pointer">Đăng xuất</span>
                            </li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </nav>
</header>

<section class="py-4">
    <div class="container">
        <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a class="text-primary" href="/static">Trang chủ</a></li>
                <li class="breadcrumb-item active" aria-current="page">Thông tin cá nhân
                </li>
            </ol>
        </nav>
    </div>
</section>
<section class="pb-4">
    <div class="container">
        <div class="row py-2">
            <div class="col-6">
                <button type="button" class="btn btn-primary px-4" id="btn-update">
                    Cập nhật
                </button>
                <button type="button" class="btn btn-success px-4" data-bs-toggle="modal"
                        data-bs-target="#modalPassword">
                    Đổi mật khẩu
                </button>
            </div>
        </div>

        <div class="row">
            <div class="col-6">
                <div class="row">
                    <div class="col-md-12">
                        <form id="form-update-user" class="bg-body-tertiary p-4">
                            <div class="form-group mb-3">
                                <label class="form-label">Họ tên</label>
                                <input type="text" class="form-control" id="name" name="name" />
                            </div>

                            <div class="form-group mb-3">
                                <label class="form-label">Email</label>
                                <input type="text" class="form-control" id="email" name="email" th:value="${user.email}" disabled />
                            </div>
                        </form>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mt-4">
                            <div class="user-avatar-container d-flex align-items-start flex-column">
                                <img id="avatar-preview"
                                     src="https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=500&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mjh8fG1lbnxlbnwwfHwwfHx8MA%3D%3D"
                                     alt="" class="w-100" style="aspect-ratio: 1 / 1; object-fit: cover">
                                <label for="avatar" class="btn btn-warning w-100 mt-2">Đổi Avatar</label>
                                <input type="file" id="avatar" class="d-none">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="modal fade" id="modalPassword" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
     aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel">Đổi mật khẩu</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-update-password">
                    <div class="form-group mb-3">
                        <label for="oldPassword" class="form-label">Mật khẩu cũ</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="oldPassword" name="oldPassword">
                            <span class="input-group-text">
                                    <i class="fa-regular fa-eye"></i>
                                </span>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label for="newPassword" class="form-label">Mật khẩu mới</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="newPassword" name="newPassword">
                            <span class="input-group-text">
                                    <i class="fa-regular fa-eye"></i>
                                </span>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label for="confirmPassword" class="form-label">Mật khẩu xác nhận</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword">
                            <span class="input-group-text">
                                    <i class="fa-regular fa-eye"></i>
                                </span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="btn-update-password">Xác nhận</button>
            </div>
        </div>
    </div>
</div>


<footer class="py-4 bg-dark">
    <div class="container">
        <div class="row">
            <div class="col-4">
                <img src="https://motchilltv.io/logo_motchill.png" alt="" class="logo">
                <p class="text-white mt-3">Motchill - Xem phim Online Vietsub chất lượng cao miễn phí, nhiều thể loại
                    phim phong phú, đặc sắc, giao diện trực quan, thuận tiện, tốc độ tải nhanh, thường xuyên cập nhật
                    các bộ phim mới.</p>
            </div>
            <div class="col">
                <div class="text-white">
                    <h5 class="text-uppercase mb-3 fw-normal">Danh mục</h5>
                    <p>Tin tức</p>
                    <p>Phim chiếu rạp</p>
                    <p>Phim lẻ</p>
                    <p>Phim bộ</p>
                    <p>TV Show</p>
                </div>
            </div>
            <div class="col">
                <div class="text-white">
                    <h5 class="text-uppercase mb-3 fw-normal">Danh mục</h5>
                    <p>Tin tức</p>
                    <p>Phim chiếu rạp</p>
                    <p>Phim lẻ</p>
                    <p>Phim bộ</p>
                    <p>TV Show</p>
                </div>
            </div>
            <div class="col">
                <div class="text-white">
                    <h5 class="text-uppercase mb-3 fw-normal">Danh mục</h5>
                    <p>Tin tức</p>
                    <p>Phim chiếu rạp</p>
                    <p>Phim lẻ</p>
                    <p>Phim bộ</p>
                    <p>TV Show</p>
                </div>
            </div>
            <div class="col">
                <div class="text-white">
                    <h5 class="text-uppercase mb-3 fw-normal">Danh mục</h5>
                    <p>Tin tức</p>
                    <p>Phim chiếu rạp</p>
                    <p>Phim lẻ</p>
                    <p>Phim bộ</p>
                    <p>TV Show</p>
                </div>
            </div>
        </div>
    </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"
        integrity="sha512-VEd+nq25CkR676O+pLBnDW09R7VQX9Mdiij052gVCp5yVH3jGtH70Ho/UUv4mJDsEdTvqRCFZg0NKGiojGnUCw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script th:src="@{/web-assets/js/movie.js}"></script>
<script th:src="@{/web-assets/js/main.js}"></script>

<script>
    const btns = document.querySelectorAll('#form-update-password span.input-group-text');
    const passwordEls = document.querySelectorAll('#form-update-password input[type="password"]');
    btns.forEach((btn, index) => {
        btn.addEventListener("click", () => {
            const passwordEl = passwordEls[index];
            if (passwordEl.type === "password") {
                passwordEl.type = "text";
                btn.innerHTML = '<i class="fa-regular fa-eye-slash"></i>';
            } else {
                passwordEl.type = "password";
                btn.innerHTML = '<i class="fa-regular fa-eye"></i>';
            }
        })
    })
</script>

// update userName
<script>
    const updateUserProfile = async () => {
        const nameInputEl = document.getElementById('name');
        const name = nameInputEl.value.trim();

        if (name === "") {
            toastr.warning("Vui lòng nhập họ và tên");
            return;
        }

        const request = {
            name: name
        };

        try {
            let res = await axios.put('/api/users/update-profile', request);
            toastr.success(res.data);
            nameInputEl.value = "";

            const nameDisplayEl = document.querySelector('.dropdown-toggle');
            if (nameDisplayEl) {
                nameDisplayEl.innerText = name;
            }
        } catch (error) {
            console.log(error);
            toastr.error(error.response.data);
        }
    };
    document.getElementById('btn-update').addEventListener('click', updateUserProfile);
</script>


// Update password
<script>
    const updatePassword = async () => {
        const oldPassword = document.getElementById('oldPassword').value.trim();
        const newPassword = document.getElementById('newPassword').value.trim();
        const confirmPassword = document.getElementById('confirmPassword').value.trim();

        // Kiểm tra đầu vào
        if (oldPassword === "") {
            toastr.warning("Vui lòng nhập mật khẩu cũ");
            return;
        }

        if (newPassword === "") {
            toastr.warning("Vui lòng nhập mật khẩu mới");
            return;
        }

        if (confirmPassword === "") {
            toastr.warning("Vui lòng nhập mật khẩu xác nhận");
            return;
        }

        if (newPassword !== confirmPassword) {
            toastr.warning("Mật khẩu xác nhận không khớp");
            return;
        }

        const request = {
            oldPassword: oldPassword,
            newPassword: newPassword,
            confirmPassword: confirmPassword
        };

        try {
            let res = await axios.put('/api/users/update-password', request);
            toastr.success(res.data);
            document.getElementById('form-update-password').reset();
        } catch (error) {
            console.log(error);
            toastr.error(error.response.data || "Đã có lỗi xảy ra");
        }
    };
    document.getElementById('btn-update-password').addEventListener('click', updatePassword);
</script>


<script>
    const formLoginEl = document.getElementById('form-login');
    const emailEl = document.getElementById('email');
    const passwordEl = document.getElementById('password');
    formLoginEl.addEventListener('submit', async function (e) {
        e.preventDefault();
        const email = emailEl.value;
        const password = passwordEl.value;
        const data = {
            email,
            password
        };
        try {
            const response = await axios.post('/api/auth/login', data);
            toastr.success('Đăng nhập thành công');
            setTimeout(() => {
                window.location.href = '/';
            }, 1000);
        } catch (e) {
            toastr.error('Đăng nhập thất bại');
        }
    });
</script>
</body>
</html>